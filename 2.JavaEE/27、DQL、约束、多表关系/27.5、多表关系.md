# 27.5、多表关系

## 1、多表关系

- 多表之间的关系：

  1. 一对一的关系。
  2. 一对多 或 多对一 的关系。
  3. 多对多的关系。

- 一对多关系实现：在多的一方建立外键列，指向一的一方的主键。

- 多对多关系实现：需要借助第三张中间表，中间表中至少包含两个字段，作为外键分别指向两张表的主键。这两个字段构成了联合主键。

- 一对一关系实现：在任意一方添加外键列，指向另一方的主键。而且需要在外键列添加唯一约束。

- 分析示例：用户收藏旅游线路。

  1. 三个实体：旅游线路分类、旅游线路、用户。

  2. 旅游线路分类和旅游线路是 一对多 的关系。

  3. 用户和收藏的旅游线路是 多对多 的关系。

  4. 实现：

     ```mysql
     CREATE TABLE category(
     	cid INT PRIMARY KEY AUTO_INCREMENT,
     	cname VARCHAR(100) NOT NULL UNIQUE
     );
     
     CREATE TABLE route(
     	rid INT PRIMARY KEY AUTO_INCREMENT,
     	rname VARCHAR(100) NOT NULL UNIQUE,
     	CONSTRAINT r_c FOREIGN KEY (rid) REFERENCES category(cid)
     );
     
     CREATE TABLE users(
     	uid INT PRIMARY KEY AUTO_INCREMENT,
     	uname VARCHAR(100)
     );
     
     CREATE TABLE favorite(
     	rid INT,
     	uid INT,
     	PRIMARY KEY(rid,uid),	# 添加联合主键
     	CONSTRAINT f_r FOREIGN KEY (rid) REFERENCES route(rid),
     	CONSTRAINT f_u FOREIGN KEY (uid) REFERENCES users(uid)
     );
     ```

## 2、范式

- 数据库设计的范式：设计数据库时，所需要遵循的规范。

  - 目前关系数据库有六种范式，各个范式呈递次规范。即要遵循前边的范式，必须先遵循前边的范式。主要的是前三种范式。

  - 第一范式：每一列都是不可分割的原子数据项。

    可能存在一些问题：

    - 存在严重的数据冗余、重复。
    - 数据添加可能存在问题。
    - 数据删除可能会将将相关的数据都受到影响。

  - 第二范式：在第一范式的基础上，非码属性必须完全依赖于码（在第一范式的基础上消除非主属性对主码的部分函数依赖）。

    - 函数依赖：如果通过A属性（属性组，即多个属性的组合）的值，可以唯一确定B属性的值，则称B依赖于A。
    - 完全函数依赖：如果A是一个属性组，则B属性值的确定需要依赖于A属性组中的所有属性值。
    - 部分函数依赖：如果A是一个属性组，则B属性值的确定只需要依赖于A属性组中的部分属性值。
    - 传递函数依赖：如果B依赖于A，C依赖于B，则称C传递函数依赖于A。
    - 码：如果在一张表中，一个属性或属性组，被其他所有属性或属性组依赖，则称其为这张表的码。
      - 主属性：码属性组中的所有属性。
      - 非主属性：除了码属性组中的属性。

    可能存在一些问题：

    - 解决了数据的冗余、重复问题。
    - 没有解决数据添加和删除的问题。

  - 第三范式：在第二范式的基础上，任何非主属性不依赖于其他非主属性（在第二范式的基础上消除传递依赖）。

    - 解决了数据添加和删除的问题。

- 使用三个范式的示例：学生成绩表。

  - 原始表分为，列：学号、姓名、系、课程名称和分数。其中系列下分为系名和系主任。
  - 应用第一范式：将系列分割为列系名和系主任。
  - 应用第二范式：
    - 原表中，主属性组是 学号和课程名称，分数同时依赖于主属性组，但姓名、系名和系主任只部分依赖于主属性组中的学号。
    - 将原表分为选课表和学生表。选课表包括列：学号、课程名称和分数。主属性组是学号和课程名称，分数完全依赖于主属性组。学生表包括列：学号、姓名、系名和系主任。主属性是学号，其他非主属性完全依赖于主属性。
  - 应用第三范式：
    - 在学生表中，系主任对学号是传递依赖。
    - 将原学生表分为学生表和系表。系表包括列：系名和系主任。系名为主属性，系主任完全依赖于系名。

- 数据库的备份与还原：

  - 命令行备份：`mysqldump -u用户名 -p密码 数据库名 > 保存的路径`。
  - 命令行还原：
    1. 登录数据库。
    2. 创建数据库。
    3. 使用数据库。
    4. 读入备份文件：`source 备份路径 `。

