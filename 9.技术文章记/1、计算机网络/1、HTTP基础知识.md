学习自：

- [你每天都在使用的HTTP协议，到底是什么鬼？](https://mp.weixin.qq.com/s/AK1Pb9rx0q5Hf8dq6HNOhw)（这篇写的好差）
- [HTTP协议格式详解](https://www.cnblogs.com/breka/articles/9791664.html)
- [硬核！30 张图解 HTTP 常见的面试题](https://mp.weixin.qq.com/s/amOya0M00LwpL5kCS96Y6w)（写得好）



### 什么是HTTP？

- HTTP是超文本传输协议，HTTP是缩写，它的全英文名是HyperText Transfer Protocol。
- 什么是超文本呢？
  - 超文本指的是HTML，css，JavaScript和图片等，HTTP的出现是为了接收和发布HTML页面，经过不断的发展也可以用于接收一些音频，视频，文件等内容。
- 请求访问文本或图片等资源的一方，我们叫做客户端；负责接收，提供响应的一方称为服务器端。
- Client客户端请求Server服务端，Server服务端响应给Client客户端。一次请求和一次响应就达成了一次通信。
- HTTP的特点：
  - HTTP都是由客户端发起请求的，并且由服务器端回应响应消息的。
  - 简单快速，客户端向服务器端请求服务时，只需传送请求方法和路径。
  - 灵活，允许传输任何类型的数据对象，包括音频，视频，图片，文件等等。
  - 无状态，就是说，每次HTTP请求都是独立的，任何两个请求之间没有必然的联系。
  - 无连接的，每次服务器在处理完客户端的请求后，并收到客户的应答后，就断开了通信，当客户端再次发送请求时就是一个新的连接。
- HTTP的缺点：
  - 明文传输。
  - 不安全。HTTP 的安全问题，可以用 HTTPS 的方式解决，也就是通过引入 SSL/TLS 层，增加了安全性。
- 无连接是HTTP/1.0版的主要缺点，每个TCP连接只能发送一个请求，发送数据完毕后，连接就关闭了，如果还要请求就必须要新建一个请求连接。
- HTTP1.1虽然是无状态协议，但是为了实现期望的保持状态功能，于是引入了Cookie技术，有了Cookie，和HTTP协议通信，就可以管理状态了。
- HTTP1.1版本是最流行的版本，可以持久连接，TCP连接默认不关闭，可以被多个请求复用，只有在一段时间内，没有请求，才自动关闭（keep-alive）。



### HTTP消息结构

- 请求消息：
  - 请求行。包括请求方式，请求URI和HTTP协议版本。
  - 请求头。键值对格式的相关请求信息。
  - 请求空行。
  - 消息体。请求内容。
- 响应消息：
  - 状态行。包括HTTP协议版本，状态码和状态消息。
  - 响应头。键值对格式的相关响应信息。
  - 响应空行。
  - 响应体。响应内容。
- 状态码：HTTP协议的状态码由3位数字组成，第一个数字定义了响应的类别，共有5中类别：
  - 1xx: 指示信息--表示请求已接收，继续处理。
  - 2xx: 成功--表示请求已被成功接收、理解、接受。
  - 3xx: 重定向--要完成请求必须进行更进一步的操作。
  - 4xx: 客户端错误--请求有语法错误或请求无法实现。
  - 5xx: 服务器端错误--服务器未能实现合法的请求。

- 请求方法：

  - `HTTP`定义了多种请求方法，来满足各种需求。
  - `HTTP/1.0`定义了三种请求方法：`GET`、`POST` 和 `HEAD`。
  - 到了`HTTP/1.1`，新增了五种请求方法：`OPTIONS`、`PUT`、`DELETE`、`TRACE` 和 `CONNECT`。
  - 各个请求方法的具体功能如下：

  ```html
  GET         请求指定的页面信息，并返回实体主体。
  HEAD        类似于get请求，只不过返回的响应中没有具体的内容，用于获取报头
  POST        向指定资源提交数据进行处理请求（例如提交表单或者上传文件）。数据被包含在请求体中。POST请求可能会导致新的资源的建立和/或已有资源的修改。
  PUT         从客户端向服务器传送的数据取代指定的文档的内容。
  DELETE      请求服务器删除指定的页面。
  CONNECT     HTTP/1.1协议中预留给能够将连接改为管道方式的代理服务器。
  OPTIONS     允许客户端查看服务器的性能。
  TRACE       回显服务器收到的请求，主要用于测试或诊断。
  ```

- 常见字段：

  - 请求字段：
    - Host：客户端发送请求时，用来指定服务器的域名。
    - Connection：常用于客户端要求服务器使用 TCP 持久连接，以便其他请求复用。HTTP/1.1 版本的默认连接都是持久连接。
    - Accept：声明自己可以接受哪些数据格式。
    - Accept-Encoding：说明自己可以接受哪些压缩方法。
  - 响应字段：
    - Content-Length：表明本次回应的数据长度。
    - Content-Type：用于服务器回应时，告诉客户端，本次数据是什么格式。
    - Content-Encoding：说明数据的压缩方法。

- GET与POST的区别：

  - 含义的不同：
    - GET请求是从服务器请求URI获取资源。
    - POST请求是往URI提交数据。

  - 请求参数的区别：
    - GET请求会把请求的参数拼接在URL后面，以?分隔，多个参数之间用&连接；如果是英文或数字，原样发送，如果是空格或中文，则用Base64编码。
    - POST请求会把提交的数据放在请求体中，不会在URL中显示出来。
  - 传输数据的大小：
    - GET: 浏览器和服务器会限制URL的长度，所以传输的数据有限，一般是2K。
    - POST: 由于数据不是通过URL传递，所以一般可以传输较大量的数据。
  - 安全性：
    - GET: 请求参数在URL后面，可以直接看到。
    - POST: 请求参数在请求体里面传输，无法直接拿到，相对GET安全性较高；但是通过抓包工具，还是可以看到请求参数的。

- 安全和幂等的概念：

  - 在 HTTP 协议里，所谓的「安全」是指请求方法不会「破坏」服务器上的资源。
  - 所谓的「幂等」，意思是多次执行相同的操作，结果都是「相同」的。
  -  GET 方法就是安全且幂等的，因为它是「只读」操作，无论操作多少次，服务器上的数据都是安全的，且每次的结果都是相同的。
  - POST 因为是「新增或提交数据」的操作，会修改服务器上的资源，所以是不安全的，且多次提交数据就会创建多个资源，所以不是幂等的。



### HTTP性能

- HTTP 1.1协议是基于 TCP/IP，并且使用了「请求 - 应答」的通信模式，所以性能的关键就在这两点里。

- 长连接：

  - 早期 HTTP/1.0 性能上的一个很大的问题，那就是每发起一个请求，都要新建一次 TCP 连接（三次握手），而且是串行请求，做了无畏的 TCP 连接建立和断开，增加了通信开销。
  - 为了解决上述 TCP 连接问题，HTTP/1.1 提出了长连接的通信方式，也叫持久连接。这种方式的好处在于减少了 TCP 连接的重复建立和断开所造成的额外开销，减轻了服务器端的负载。
  - 持久连接的特点是，只要任意一端没有明确提出断开连接，则保持 TCP 连接状态。

  ![](http://iwehdio.gitee.io/img/my-img/20-12/20201231185802.png)

- 管道网络传输：

  - HTTP/1.1 采用了长连接的方式，这使得管道（pipeline）网络传输成为了可能。
  - 即可在同一个 TCP 连接里面，客户端可以发起多个请求，只要第一个请求发出去了，不必等其回来，就可以发第二个请求出去，可以减少整体的响应时间。
  - 举例来说，客户端需要请求两个资源。以前的做法是，在同一个TCP连接里面，先发送 A 请求，然后等待服务器做出回应，收到后再发出 B 请求。管道机制则是允许浏览器同时发出 A 请求和 B 请求。
  - 但是服务器还是按照顺序，先回应 A 请求，完成后再回应 B 请求。要是 前面的回应特别慢，后面就会有许多请求排队等着。这称为「队头堵塞」。

  ![](http://iwehdio.gitee.io/img/my-img/20-12/20201231185803.png)

  

- 队头阻塞：

  - 「请求 - 应答」的模式加剧了 HTTP 的性能问题。因为当顺序发送的请求序列中的一个请求因为某种原因被阻塞时，在后面排队的所有请求也一同被阻塞了，会招致客户端一直请求不到数据，这也就是「队头阻塞」。
  - 总之 HTTP/1.1 的性能一般般，后续的 HTTP/2 和 HTTP/3 就是在优化 HTTP 的性能。

  ![](http://iwehdio.gitee.io/img/my-img/20-12/20201231185804.png)



### HTTPS

- HTTP 与 HTTPS 有哪些区别？
  - HTTP 是超文本传输协议，信息是明文传输，存在安全风险的问题。HTTPS 则解决 HTTP 不安全的缺陷，在 TCP 和 HTTP 网络层之间加入了 SSL/TLS 安全协议，使得报文能够加密传输。
  - HTTP 连接建立相对简单， TCP 三次握手之后便可进行 HTTP 的报文传输。而 HTTPS 在 TCP 三次握手之后，还需进行 SSL/TLS 的握手过程，才可进入加密报文传输。
  - HTTP 的端口号是 80，HTTPS 的端口号是 443。
  - HTTPS 协议需要向 CA（证书权威机构）申请数字证书，来保证服务器的身份是可信的。
- HTTPS 解决了 HTTP 的哪些问题？
  - HTTP存在的安全问题：
    - 窃听风险，比如通信链路上可以获取通信内容。
    - 篡改风险，比如强制入垃圾广告，视觉污染。
    - 冒充风险，比如冒充淘宝网站。
  - 加入SSL/TSL协议后的HTTPS：
    - 信息加密：交互信息无法被窃取。
    - 校验机制：无法篡改通信内容，篡改了就不能正常显示。
    - 身份证书：证明淘宝是真的淘宝网。
- HTTPS 是如何解决上面的三个风险的？
  - 混合加密的方式实现信息的机密性，解决了窃听的风险。
  - 摘要算法的方式来实现完整性，它能够为数据生成独一无二的「指纹」，指纹用于校验数据的完整性，解决了篡改的风险。
  - 将服务器公钥放入到数字证书中，解决了冒充的风险。

具体的加密方法和SSL/TLS 的建立过程之后再看。



### HTTP协议演进

- HTTP/1.1 相比 HTTP/1.0 提高了什么性能？

  - 使用 TCP 长连接的方式改善了 HTTP/1.0 短连接造成的性能开销。
  - 支持 管道（pipeline）网络传输，只要第一个请求发出去了，不必等其回来，就可以发第二个请求出去，可以减少整体的响应时间。

- HTTP/1.1 还是有性能瓶颈：

  - 发送冗长的首部。每次互相发送相同的首部造成的浪费较多；
  - 服务器是按请求的顺序响应的，如果服务器响应慢，会招致客户端一直请求不到数据，也就是队头阻塞；
  - 没有请求优先级控制；
  - 请求只能从客户端开始，服务器只能被动响应。

- 针对HTTP/1.1 的性能瓶颈，HTTP/2 做了什么优化？

  - HTTP/2 协议是基于 HTTPS 的，所以 HTTP/2 的安全性也是有保障的。

  - 头部压缩：

    - HTTP/2 会压缩头（Header）如果你同时发出多个请求，他们的头是一样的或是相似的，那么，协议会帮你消除重复的部分。
    - 这就是所谓的 HPACK 算法：在客户端和服务器同时维护一张头信息表，所有字段都会存入这个表，生成一个索引号，以后就不发送同样字段了，只发送索引号，这样就提高速度了。

  - 二进制格式：

    - 头信息和数据体都是二进制，并且统称为帧（frame）：头信息帧和数据帧。
    - 直接解析二进制报文，增加了数据传输的效率。

  - 数据流：

    - HTTP/2 的数据包不是按顺序发送的，同一个连接里面连续的数据包，可能属于不同的回应。因此，必须要对数据包做标记，指出它属于哪个回应。
    - 每个请求或回应的所有数据包，称为一个数据流（Stream）。
    - 每个数据流都标记着一个独一无二的编号，其中规定客户端发出的数据流编号为奇数， 服务器发出的数据流编号为偶数。
    - 客户端还可以指定数据流的优先级。优先级高的请求，服务器就先响应该请求。

  - 多路复用：

    - HTTP/2 是可以在一个连接中并发多个请求或回应，而不用按照顺序一一对应。
    - 移除了 HTTP/1.1 中的串行请求，不需要排队等待，也就不会再出现「队头阻塞」问题，降低了延迟，大幅度提高了连接的利用率。
    - 举例来说，在一个 TCP 连接里，服务器收到了客户端 A 和 B 的两个请求，如果发现 A 处理过程非常耗时，于是就回应 A 请求已经处理好的部分，接着回应 B 请求，完成后，再回应 A 请求剩下的部分。

    ![](http://iwehdio.gitee.io/img/my-img/20-12/20201231185805.png)

  - 服务器推送：

    - HTTP/2 还在一定程度上改善了传统的「请求 - 应答」工作模式，服务不再是被动地响应，也可以主动向客户端发送消息。
    - 举例来说，在浏览器刚请求 HTML 的时候，就提前把可能会用到的 JS、CSS 文件等静态资源主动发给客户端，减少延时的等待，也就是服务器推送（Server Push，也叫 Cache Push）。

- HTTP/2 有哪些缺陷？HTTP/3 做了哪些优化？
  - HTTP/2 主要的问题在于：多个 HTTP 请求在复用一个 TCP 连接，下层的 TCP 协议是不知道有多少个 HTTP 请求的。
  - 所以一旦发生了丢包现象，就会触发 TCP 的重传机制，这样在一个 TCP 连接中的所有的 HTTP 请求都必须等待这个丢了的包被重传回来。
    - 这都是基于 TCP 传输层的问题，所以 HTTP/3 把 HTTP 下层的 TCP 协议改成了 UDP。
    - UDP 发送是不管顺序，也不管丢包的，所以不会出现 HTTP/1.1 的队头阻塞 和 HTTP/2 的一个丢包全部重传问题。
    - UDP 是不可靠传输的，但基于 UDP 的 QUIC 协议 可以实现类似 TCP 的可靠性传输。
    - QUIC 有自己的一套机制可以保证传输的可靠性的。当某个流发生丢包时，只会阻塞这个流，其他流不会受到影响。
  - TL3 升级成了最新的 1.3 版本，头部压缩算法也升级成了 QPack。
  - HTTPS 要建立一个连接，要花费 6 次交互，先是建立三次握手，然后是 TLS/1.3 的三次握手。QUIC 直接把以往的 TCP 和 TLS/1.3 的 6 次交互合并成了 3 次，减少了交互次数。
  - QUIC 是新协议，对于很多网络设备，根本不知道什么是 QUIC，只会当做 UDP，这样会出现新的问题。所以 HTTP/3 现在普及的进度非常的缓慢。

![](http://iwehdio.gitee.io/img/my-img/20-12/20201231185806.png)

